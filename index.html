<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeonChat - Moderner Online Chatroom</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --card-bg: rgba(255, 255, 255, 0.95);
            --glass: rgba(255, 255, 255, 0.1);
            --shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px var(--primary); }
            50% { box-shadow: 0 0 40px var(--accent); }
        }

        /* Notification Animation */
        @keyframes notification {
            0% { transform: translateX(100%); opacity: 0; }
            10% { transform: translateX(0); opacity: 1; }
            90% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.8s ease-out;
        }

        /* Header */
        .header {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px 40px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideIn 0.6s ease-out;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo i {
            animation: float 3s ease-in-out infinite;
            font-size: 2.5rem;
        }

        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 25px;
            min-height: 80vh;
        }

        /* Sidebar */
        .sidebar {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideIn 0.7s ease-out;
        }

        .user-info {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            animation: glow 3s infinite;
            transition: var(--transition);
        }

        .avatar:hover {
            transform: rotate(10deg) scale(1.1);
        }

        .username {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Rooms Section */
        .rooms-section {
            margin-bottom: 30px;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .btn-create-room {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .btn-create-room:hover {
            background: var(--primary-dark);
            transform: rotate(90deg);
        }

        .rooms-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .room-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
            animation: fadeIn 0.5s ease-out;
        }

        .room-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .room-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            border-color: var(--primary);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .room-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .room-users {
            font-size: 0.8rem;
            color: var(--accent);
            background: rgba(6, 182, 212, 0.1);
            padding: 3px 8px;
            border-radius: 10px;
        }

        .room-topic {
            font-size: 0.9rem;
            color: var(--gray);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Chat Area */
        .chat-area {
            display: flex;
            flex-direction: column;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            animation: fadeIn 0.8s ease-out;
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .current-room {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .messages-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: rgba(15, 23, 42, 0.5);
        }

        .message {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.4s ease-out;
            transition: var(--transition);
        }

        .message:hover {
            transform: translateY(-2px);
        }

        .message.own {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-bottom-right-radius: 5px;
        }

        .message.other {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 5px;
            backdrop-filter: blur(5px);
        }

        .message-system {
            align-self: center;
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid var(--accent);
            text-align: center;
            max-width: 90%;
            padding: 10px 20px;
            border-radius: 12px;
            color: var(--accent);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .message-time {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .message-content {
            line-height: 1.5;
            word-break: break-word;
        }

        /* Message Input */
        .message-input-area {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 15px;
        }

        .message-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.07);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 15px 20px;
            color: white;
            font-size: 1rem;
            transition: var(--transition);
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-send {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .btn-send:hover {
            transform: scale(1.1) rotate(10deg);
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
        }

        /* Login Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease-out;
        }

        .modal-content {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        .modal-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-subtitle {
            text-align: center;
            color: var(--gray);
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--gray);
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.07);
            border: 2px solid transparent;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            transition: var(--transition);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            animation: notification 5s ease-in-out;
            z-index: 1001;
            display: none;
        }

        /* Online Users */
        .online-users {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .online-user {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .user-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .message {
                max-width: 85%;
            }
        }

        @media (max-width: 640px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .message {
                max-width: 95%;
            }
            
            .room-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }

        /* Typing Indicator */
        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h1 class="modal-title">
                <i class="fas fa-comments"></i> NeonChat
            </h1>
            <p class="modal-subtitle">Willkommen im modernen Chatroom</p>
            
            <div class="input-group">
                <label for="username">Benutzername</label>
                <input type="text" id="username" placeholder="Gib deinen Namen ein" maxlength="20">
            </div>
            
            <div class="input-group">
                <label for="avatarColor">Avatar-Farbe w√§hlen</label>
                <input type="color" id="avatarColor" value="#6366f1">
            </div>
            
            <button class="btn-login" id="btnLogin">
                <i class="fas fa-sign-in-alt"></i> Chat betreten
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div class="container" id="app" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-comment-dots"></i>
                <span>NeonChat</span>
            </div>
            
            <div class="user-info-mini">
                <div class="avatar-mini" id="userAvatarMini"></div>
                <span id="currentUsername"></span>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- User Info -->
                <div class="user-info">
                    <div class="avatar" id="userAvatar">
                        <span id="avatarInitial">U</span>
                    </div>
                    <h3 class="username" id="sidebarUsername">Benutzer</h3>
                    <div class="status">
                        <span class="status-dot"></span>
                        <span>Online</span>
                    </div>
                </div>

                <!-- Rooms -->
                <div class="rooms-section">
                    <div class="section-title">
                        <span><i class="fas fa-hashtag"></i> Chatr√§ume</span>
                        <button class="btn-create-room" id="btnCreateRoom" title="Neuen Raum erstellen">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div class="rooms-list" id="roomsList">
                        <!-- Rooms werden dynamisch geladen -->
                    </div>
                </div>

                <!-- Online Users -->
                <div class="rooms-section">
                    <div class="section-title">
                        <span><i class="fas fa-users"></i> Online (<span id="onlineCount">0</span>)</span>
                    </div>
                    <div class="online-users" id="onlineUsers">
                        <!-- Online users werden dynamisch geladen -->
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="chat-area">
                <!-- Chat Header -->
                <div class="chat-header">
                    <h2 class="current-room" id="currentRoom">Willkommen bei NeonChat!</h2>
                    <div class="room-info">
                        <span><i class="fas fa-users"></i> <span id="roomUserCount">0</span> Benutzer</span>
                        <span><i class="fas fa-comment"></i> <span id="messageCount">0</span> Nachrichten</span>
                    </div>
                </div>

                <!-- Messages -->
                <div class="messages-container" id="messagesContainer">
                    <div class="message message-system">
                        Willkommen im NeonChat! W√§hle einen Raum aus der Sidebar oder erstelle einen neuen.
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span id="typingUsers"></span>
                </div>

                <!-- Message Input -->
                <div class="message-input-area">
                    <input type="text" 
                           class="message-input" 
                           id="messageInput" 
                           placeholder="Schreibe eine Nachricht..." 
                           disabled>
                    <button class="btn-send" id="btnSend" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Firebase Konfiguration (Eigene Keys hier einf√ºgen!)
        const firebaseConfig = {
            apiKey: "AIzaSyDDeAdBeDadaKeyHierEinfuegen123",
            authDomain: "dein-chatroom.firebaseapp.com",
            projectId: "dein-chatroom",
            storageBucket: "dein-chatroom.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890"
        };

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // App Zustand
        let currentUser = null;
        let currentRoom = null;
        let rooms = [];
        let users = new Map();
        let typingUsers = new Set();
        let typingTimeout = null;

        // DOM Elemente
        const loginModal = document.getElementById('loginModal');
        const appContainer = document.getElementById('app');
        const usernameInput = document.getElementById('username');
        const avatarColorInput = document.getElementById('avatarColor');
        const btnLogin = document.getElementById('btnLogin');
        const btnCreateRoom = document.getElementById('btnCreateRoom');
        const roomsList = document.getElementById('roomsList');
        const currentRoomTitle = document.getElementById('currentRoom');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const btnSend = document.getElementById('btnSend');
        const onlineUsers = document.getElementById('onlineUsers');
        const onlineCount = document.getElementById('onlineCount');
        const roomUserCount = document.getElementById('roomUserCount');
        const messageCount = document.getElementById('messageCount');
        const typingIndicator = document.getElementById('typingIndicator');
        const typingUsersSpan = document.getElementById('typingUsers');
        const notification = document.getElementById('notification');
        const userAvatar = document.getElementById('userAvatar');
        const avatarInitial = document.getElementById('avatarInitial');
        const sidebarUsername = document.getElementById('sidebarUsername');
        const currentUsername = document.getElementById('currentUsername');
        const userAvatarMini = document.getElementById('userAvatarMini');

        // Initiale R√§ume
        const initialRooms = [
            {
                id: "general",
                name: "üåü Allgemein",
                topic: "Allgemeine Unterhaltungen",
                users: 0
            },
            {
                id: "gaming",
                name: "üéÆ Gaming",
                topic: "√úber Spiele und Gaming",
                users: 0
            },
            {
                id: "music",
                name: "üéµ Musik",
                topic: "Musik aller Art",
                users: 0
            },
            {
                id: "tech",
                name: "üíª Tech Talk",
                topic: "Technologie und Programmierung",
                users: 0
            }
        ];

        // Benutzer anmelden
        btnLogin.addEventListener('click', loginUser);
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginUser();
        });

        async function loginUser() {
            const username = usernameInput.value.trim();
            const avatarColor = avatarColorInput.value;
            
            if (!username || username.length < 2) {
                showNotification("Bitte gib einen g√ºltigen Namen ein (mind. 2 Zeichen)");
                return;
            }

            try {
                // Anonym anmelden (oder mit eigener Auth-Logik)
                const userCredential = await auth.signInAnonymously();
                currentUser = {
                    uid: userCredential.user.uid,
                    username: username,
                    avatarColor: avatarColor,
                    status: 'online',
                    lastSeen: new Date(),
                    currentRoom: null
                };

                // Avatar initialisieren
                const initial = username.charAt(0).toUpperCase();
                avatarInitial.textContent = initial;
                sidebarUsername.textContent = username;
                currentUsername.textContent = username;
                userAvatar.style.background = avatarColor;
                userAvatarMini.style.background = avatarColor;
                userAvatarMini.textContent = initial;
                userAvatarMini.className = "avatar-mini";
                userAvatarMini.style.cssText = `
                    width: 35px;
                    height: 35px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    color: white;
                `;

                // Benutzer in Firestore speichern
                await db.collection('users').doc(currentUser.uid).set({
                    ...currentUser,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Initiale R√§ume erstellen
                await createInitialRooms();

                // Modus wechseln
                loginModal.style.display = 'none';
                appContainer.style.display = 'block';
                
                // Event Listeners setzen
                setupEventListeners();
                
                // R√§ume laden
                loadRooms();
                
                // Online Status setzen
                updateUserStatus('online');
                
                showNotification(`Willkommen, ${username}! üëã`);
                
            } catch (error) {
                console.error("Login error:", error);
                showNotification("Fehler beim Einloggen. Bitte versuche es erneut.");
            }
        }

        async function createInitialRooms() {
            for (const room of initialRooms) {
                await db.collection('rooms').doc(room.id).set({
                    name: room.name,
                    topic: room.topic,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid,
                    userCount: 0
                }, { merge: true });
            }
        }

        function setupEventListeners() {
            // Raum erstellen
            btnCreateRoom.addEventListener('click', createRoom);
            
            // Nachricht senden
            btnSend.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Typing Indicator
            messageInput.addEventListener('input', handleTyping);
            
            // Fenster schlie√üen
            window.addEventListener('beforeunload', () => {
                if (currentUser) {
                    updateUserStatus('offline');
                }
            });
        }

        async function createRoom() {
            const roomName = prompt("Name des neuen Raums:");
            if (!roomName || roomName.trim().length < 3) {
                showNotification("Raumname muss mindestens 3 Zeichen haben");
                return;
            }
            
            const roomTopic = prompt("Thema/Beschreibung:");
            const roomId = Date.now().toString();
            
            try {
                const room = {
                    id: roomId,
                    name: roomName,
                    topic: roomTopic || "Neuer Chatraum",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid,
                    userCount: 0
                };
                
                await db.collection('rooms').doc(roomId).set(room);
                showNotification(`Raum "${roomName}" erstellt! üéâ`);
                
            } catch (error) {
                console.error("Error creating room:", error);
                showNotification("Fehler beim Erstellen des Raums");
            }
        }

        async function loadRooms() {
            db.collection('rooms').orderBy('createdAt', 'asc').onSnapshot((snapshot) => {
                roomsList.innerHTML = '';
                rooms = [];
                
                snapshot.forEach(doc => {
                    const room = { id: doc.id, ...doc.data() };
                    rooms.push(room);
                    
                    const roomElement = document.createElement('div');
                    roomElement.className = `room-item ${currentRoom?.id === room.id ? 'active' : ''}`;
                    roomElement.innerHTML = `
                        <div class="room-header">
                            <div class="room-name">${room.name}</div>
                            <div class="room-users">${room.userCount || 0} üë§</div>
                        </div>
                        <div class="room-topic">${room.topic || 'Keine Beschreibung'}</div>
                    `;
                    
                    roomElement.addEventListener('click', () => joinRoom(room));
                    roomsList.appendChild(roomElement);
                });
            });
        }

        async function joinRoom(room) {
            if (currentRoom?.id === room.id) return;
            
            // Alten Raum verlassen
            if (currentRoom) {
                await leaveRoom(currentRoom);
            }
            
            // Neuen Raum betreten
            currentRoom = room;
            currentRoomTitle.textContent = room.name;
            
            // UI aktualisieren
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.room-item:contains('${room.name}')`)?.classList.add('active');
            
            // Nachrichten f√ºr diesen Raum laden
            loadMessages(room.id);
            
            // Benutzerstatus aktualisieren
            await updateUserStatus('online', room.id);
            
            // Nachrichteneingabe aktivieren
            messageInput.disabled = false;
            btnSend.disabled = false;
            messageInput.focus();
            
            // Systemnachricht anzeigen
            addSystemMessage(`Du bist dem Raum "${room.name}" beigetreten.`);
        }

        async function leaveRoom(room) {
            if (!room || !currentUser) return;
            
            await db.collection('rooms').doc(room.id).update({
                userCount: firebase.firestore.FieldValue.increment(-1)
            });
            
            // Typing status zur√ºcksetzen
            await updateTypingStatus(false);
        }

        async function updateUserStatus(status, roomId = null) {
            if (!currentUser) return;
            
            const updates = {
                status: status,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                currentRoom: roomId
            };
            
            if (roomId) {
                // Raum User Count aktualisieren
                await db.collection('rooms').doc(roomId).update({
                    userCount: firebase.firestore.FieldValue.increment(1)
                });
            }
            
            await db.collection('users').doc(currentUser.uid).update(updates);
        }

        function loadMessages(roomId) {
            messagesContainer.innerHTML = `
                <div class="message message-system">
                    Lade Nachrichten...
                </div>
            `;
            
            db.collection('rooms').doc(roomId).collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(100)
                .onSnapshot((snapshot) => {
                    messagesContainer.innerHTML = '';
                    let msgCount = 0;
                    
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        addMessageToUI(message);
                        msgCount++;
                    });
                    
                    messageCount.textContent = msgCount;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // Typing listener f√ºr diesen Raum
                    setupTypingListener(roomId);
                });
        }

        function addMessageToUI(message) {
            const messageDiv = document.createElement('div');
            const isOwn = message.senderId === currentUser?.uid;
            const isSystem = message.type === 'system';
            
            messageDiv.className = `message ${isOwn ? 'own' : isSystem ? 'message-system' : 'other'}`;
            
            const time = message.timestamp?.toDate ? 
                message.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                'Jetzt';
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-sender">${message.senderName || 'System'}</div>
                    <div class="message-time">${time}</div>
                </div>
                <div class="message-content">${message.text}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }

        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-system';
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentRoom || !currentUser) return;
            
            try {
                const message = {
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.username,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    roomId: currentRoom.id,
                    type: 'text'
                };
                
                await db.collection('rooms').doc(currentRoom.id).collection('messages').add(message);
                messageInput.value = '';
                
                // Typing status zur√ºcksetzen
                await updateTypingStatus(false);
                
            } catch (error) {
                console.error("Error sending message:", error);
                showNotification("Fehler beim Senden der Nachricht");
            }
        }

        function handleTyping() {
            if (!currentRoom || !currentUser) return;
            
            // Typing status setzen
            updateTypingStatus(true);
            
            // Timeout zur√ºcksetzen
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                updateTypingStatus(false);
            }, 2000);
        }

        async function updateTypingStatus(isTyping) {
            if (!currentRoom || !currentUser) return;
            
            await db.collection('rooms').doc(currentRoom.id).collection('typing')
                .doc(currentUser.uid).set({
                    username: currentUser.username,
                    isTyping: isTyping,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
        }

        function setupTypingListener(roomId) {
            db.collection('rooms').doc(roomId).collection('typing')
                .onSnapshot((snapshot) => {
                    typingUsers.clear();
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.isTyping && data.username !== currentUser.username) {
                            typingUsers.add(data.username);
                        }
                    });
                    
                    if (typingUsers.size > 0) {
                        const names = Array.from(typingUsers).slice(0, 3);
                        let text = names.join(', ');
                        if (typingUsers.size > 3) {
                            text += ` und ${typingUsers.size - 3} weitere`;
                        }
                        
                        typingUsersSpan.textContent = `${text} schreibt${typingUsers.size > 1 ? 'n' : ''}...`;
                        typingIndicator.style.display = 'flex';
                    } else {
                        typingIndicator.style.display = 'none';
                    }
                });
        }

        // Online Users verfolgen
        db.collection('users').where('status', '==', 'online').onSnapshot((snapshot) => {
            onlineUsers.innerHTML = '';
            const onlineUsersList = [];
            
            snapshot.forEach(doc => {
                const user = doc.data();
                if (user.uid !== currentUser?.uid) {
                    onlineUsersList.push(user);
                    
                    const userElement = document.createElement('div');
                    userElement.className = 'online-user';
                    userElement.innerHTML = `
                        <div class="user-dot"></div>
                        <span>${user.username}</span>
                    `;
                    onlineUsers.appendChild(userElement);
                }
            });
            
            onlineCount.textContent = onlineUsersList.length + 1; // + aktueller User
        });

        // Raum User Count verfolgen
        function updateRoomUserCounts() {
            rooms.forEach(room => {
                db.collection('users').where('currentRoom', '==', room.id).get().then(snapshot => {
                    const count = snapshot.size;
                    roomUserCount.textContent = count;
                    
                    // In der Liste aktualisieren
                    const roomElement = document.querySelector(`.room-item:contains('${room.name}') .room-users`);
                    if (roomElement) {
                        roomElement.textContent = `${count} üë§`;
                    }
                });
            });
        }

        // Hilfsfunktionen
        function showNotification(text, duration = 3000) {
            notification.textContent = text;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        // Initialisiere
        setInterval(updateRoomUserCounts, 10000);
    </script>
</body>
</html>
